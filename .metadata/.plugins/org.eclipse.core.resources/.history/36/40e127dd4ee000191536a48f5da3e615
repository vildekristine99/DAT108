package no.hvl.dat108;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

//import static no.hvl.dat108.UrlMapping.LOGIN_URL;
//import static no.hvl.dat108.UrlMapping.LISTE_URL;

@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    private static String passord;
    
    @Override
	public void init(ServletConfig config) throws ServletException {
    	super.init(config);
		passord = getServletConfig().getInitParameter("passord");
		//timeout = Integer.parseInt(getServletContext().getInitParameter("timeout"));
	}

    @Override
    protected void doGet(HttpServletRequest request,
            HttpServletResponse response) throws ServletException, IOException {
    	
    	
    	String meld = "Skriv inn passord:";
    	String feilkode = request.getParameter("feilkode");
    
	        if(feilkode != null) {
	        	if(feilkode.equals("1")) {
	        	meld = "Feil passord, prøv igjen";
	        	} else if(feilkode.equals("2")) {
	        		meld = "Du er ikke pålogget, skriv inn passord";
	        	}
	        }
	    
    	
        response.setContentType("text/html; charset=ISO-8859-1");
        PrintWriter out = response.getWriter();
        out.println("<!DOCTYPE html>");
        out.println("<html>");
        out.println("<head>");
        out.println("<meta charset=\"ISO-8859-1\">");
        out.println("<title>Login</title>");
        out.println("</head>");
        out.println("<body>");        
        out.println("<form action=\"" + "login" + "\" method=\"post\">");
        out.println("  <fieldset>");
        out.println("    <legend>Login</legend>");      
        out.println("<p>" + meld + passord +"</p>");
        out.println("    <p><input type=\"password\" name=\"passord\"/></p>");
        out.println("    <p><input type=\"submit\" value=\"Logg inn\" /></p>");
        out.println("  </fieldset>");
        out.println("</form>");
        out.println("</body>");
        out.println("</html>");
    }

    @Override
    protected void doPost(HttpServletRequest request,
            HttpServletResponse response) throws ServletException, IOException {
    	
    	
        String inputPassord = request.getParameter("passord");
        HttpSession sesjon;
       
        if(passord == null || !inputPassord.equals(passord)) {
        	response.sendRedirect("login?feilkode=1");
        } else {
        	sesjon = request.getSession(false);
    		if(sesjon != null) {
    			sesjon.invalidate();
    		}
        	sesjon = request.getSession(true);
        	//sesjon.setMaxInactiveInterval(10);
        	Liste liste = new Liste();
    		sesjon.setAttribute("liste", liste);
    		sesjon.setAttribute("passord", true);
    		response.sendRedirect("liste");
        }
        
        
        
        
    }
}